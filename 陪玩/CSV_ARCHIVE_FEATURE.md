# CSV 存档功能说明

## 📋 功能概述

实现了 Discord Bot 的 CSV 导出自动存档功能。每次用户导出 CSV 文件时，Bot 会自动将 CSV 文件备份到指定的存档频道（ID: `1457035667157680431`）中。

## 🔧 实现原理

### 1. 存档频道配置
- **频道 ID**：`1457035667157680431`
- **功能**：保存所有导出的 CSV 文件及导出时间、类型、记录数等信息
- **自动保留**：所有导出历史都会被记录，便于后续查阅

### 2. 核心函数：`sendCsvToArchive()`

```javascript
async function sendCsvToArchive(filePath, fileName, orderCount, type = '')
```

**参数说明：**
- `filePath`：CSV 文件的本地路径
- `fileName`：CSV 文件名
- `orderCount`：导出的记录总数
- `type`：导出类型（如"数据管理中心导出"、"订单中心导出"等）

**功能：**
- 验证 Discord 客户端是否已准备好
- 获取指定的存档频道
- 验证文件存在性
- 生成描述消息（包含文件名、记录数、类型、时间戳）
- 发送文件到 Discord 频道
- 返回操作成功/失败状态

### 3. 存档消息格式

每个存档会显示以下信息：

```
📊 **CSV 数据存档**
📁 文件: 订单数据_2026-01-05.csv
📈 记录数: 33 条
🏷️ 类型: 数据管理中心导出
⏰ 时间: 2026-01-05 14:30:45
```

## 📤 涉及的导出按钮

### 1️⃣ 数据管理中心 - 导出 Excel
- **按钮 ID**：`datacenter_export_excel`
- **触发条件**：用户点击"数据管理中心"面板的导出按钮
- **存档类型**：`数据管理中心导出`

### 2️⃣ 单子查询中心 - 导出 Excel  
- **按钮 ID**：`export_excel`
- **触发条件**：用户点击"单子查询中心"的导出按钮
- **存档类型**：`单子查询中心导出`

### 3️⃣ 订单中心 - 导出 Excel
- **按钮 ID**：`db_export_excel`
- **触发条件**：用户点击 `/db` 面板的导出按钮
- **存档类型**：`订单中心导出`

### 4️⃣ 数据管理中心 - 导出至 Telegram
- **按钮 ID**：`datacenter_export_telegram`
- **触发条件**：用户点击"数据管理中心"的 Telegram 导出按钮
- **存档类型**：`数据管理中心Telegram导出`

### 5️⃣ 单子查询中心 - 导出至 Telegram
- **按钮 ID**：`export_telegram`
- **触发条件**：用户点击"单子查询中心"的 Telegram 导出按钮
- **存档类型**：`单子查询中心Telegram导出`

## 🔄 工作流程

```
用户点击导出按钮
    ↓
从 SQLite 读取数据
    ↓
使用 SQLite CLI 导出 CSV 文件
    ↓
发送 CSV 给用户（Discord 附件）
    ↓
异步调用 sendCsvToArchive()
    ↓
存档 CSV 到指定频道
    ↓
用户确认下载后，删除本地临时文件（5秒延迟）
```

## 💾 文件保留策略

### 本地临时文件
- **位置**：`陪玩/tmp/` 文件夹
- **保留时间**：5 秒（导出完成后）
- **自动清理**：使用 `sqliteExporter.deleteFileAsync(filePath, 5000)`

### Discord 存档频道
- **位置**：频道 ID `1457035667157680431`
- **保留时间**：永久保留（除非手动删除）
- **优势**：利用 Discord 的云存储，无需本地维护

## 📊 存档查询

用户可以在存档频道中：
1. 查看所有历史导出记录
2. 按时间查看导出历史
3. 下载之前导出的 CSV 文件
4. 了解导出的类型和记录数

## 🛡️ 错误处理

函数会处理以下错误情况：

| 错误场景 | 处理方式 | 日志输出 |
|---------|---------|---------|
| 客户端未准备好 | 跳过存档 | `⚠️ Discord 客户端未准备好` |
| 频道不存在 | 跳过存档 | `⚠️ 存档频道不存在或非文本频道` |
| 文件不存在 | 跳过存档 | `⚠️ CSV 文件不存在` |
| 其他异常 | 捕获并记录 | `❌ 发送 CSV 存档失败` |
| 成功 | 记录成功 | `✅ CSV 已存档至频道` |

## 🔐 安全性考虑

1. **频道访问权限**：只有 Bot 有权限发送消息到存档频道
2. **用户隐私**：存档文件包含敏感数据，应限制频道访问权限
3. **文件清理**：本地临时文件会自动删除，不留任何痕迹
4. **异步执行**：存档操作不阻塞用户交互，提升体验

## 📝 技术细节

### 异步执行时机

```javascript
// 同时发送到存档频道（异步执行，不阻塞用户）
setTimeout(() => {
  sendCsvToArchive(filePath, fileName, allOrders.length, '导出类型');
}, 100);
```

### 文件清理时机

```javascript
// 用户收到文件后 5 秒删除本地临时文件
sqliteExporter.deleteFileAsync(filePath, 5000);
```

## 🎯 后续优化建议

1. **分类存储**：在存档频道中按导出类型创建分组或使用 Thread
2. **自动备份**：定期自动导出完整数据库到存档频道
3. **查询历史**：添加命令查询指定日期的导出历史
4. **数据对比**：支持对比不同时间的导出数据
5. **删除管理**：添加命令清理过期的存档（如超过N天）

## 📚 相关文件修改

### index.js
- **行 70**：添加 `CSV_ARCHIVE_CHANNEL_ID` 常量
- **行 311-347**：添加 `sendCsvToArchive()` 函数
- **行 1437-1443**：修改 `datacenter_export_excel` 按钮处理
- **行 2107-2113**：修改 `export_excel` 按钮处理
- **行 3253-3259**：修改 `db_export_excel` 按钮处理
- **行 1611-1617**：修改 `datacenter_export_telegram` 按钮处理
- **行 2197-2203**：修改 `export_telegram` 按钮处理

### 无修改文件
- `sqlite-exporter.js`：正常使用
- `db.js`：正常使用
- `exporter.js`：仅用于 JSON 导出

## ✅ 测试清单

- [x] 存档频道 ID 配置正确
- [x] `sendCsvToArchive()` 函数逻辑完整
- [x] 所有5个导出按钮都调用存档函数
- [x] CSV 文件成功发送到存档频道
- [x] 消息格式显示正确（文件名、记录数、类型、时间）
- [x] 本地临时文件自动删除
- [x] 错误处理机制完善
- [x] 提交并推送到 GitHub

---

**功能完成日期**：2026-01-05  
**Git 提交**：e75684c  
**状态**：✅ 已推送到 GitHub
